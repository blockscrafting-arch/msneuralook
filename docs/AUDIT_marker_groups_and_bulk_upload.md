# Полный аудит: Группы маркеров + загрузка списком

**Дата:** 2026-02-13  
**Цель:** Проверить, что все вопросы заказчика закрыты и план на 100% точен относительно кодовой базы.

---

## 1. Требования заказчика (чеклист)

| № | Требование | Источник | Закрыто планом? |
|---|------------|----------|-----------------|
| 1 | Группы маркеров, каждая для своего канала (список А → канал А, список Б → канал Б) | Павел 10.02: «Третий пункт звучит отлично… Группы маркеров, каждая для своего канала» | Да: задача 1 — таблица `keyword_groups`, привязка к `target_channels`, расчёт каналов по тексту при публикации |
| 2 | Загрузка маркеров списком, не по одному | Павел: «список маркеров загружать не по одному, а именно списком — это точно нужно» | Да: задача 2 — кнопка «Добавить списком», FSM, парсинг (строки/запятые), отчёт добавлено/пропущено |
| 3 | Стоп-слова не делать, ручная префильтрация остаётся | Павел: «Стоп слова наверное не надо / мы пока оставим ручную префильтрацию» | Да: план не включает стоп-слова и не меняет префильтрацию |
| 4 | Две задачи можно считать и приступить | «Эти две задачи можно сразу посчитать и приступить» | Да: план разбит на задачи 1 и 2 с порядком внедрения |

**Итог:** Все заявленные вопросы заказчика закрыты планом.

---

## 2. Точность плана относительно кодовой базы

### 2.1 Критическая ошибка: номер миграции

- **В плане везде указано:** `migrate_006_keyword_groups.sql`
- **Факт в проекте:** В [DEPLOY.md](DEPLOY.md) и в `init_db/` уже есть:
  - **006** — `migrate_006_userbot_outbox.sql` (userbot outbox)
  - **007** — `migrate_007_delivery_retry.sql` (delivery_attempts, статусы)
- **Исправление:** Новая миграция должна называться **`migrate_008_keyword_groups.sql`**. В DEPLOY после 007 добавить команду применения 008 и проверку таблицы `keyword_groups` и колонки `keywords.group_id`.

### 2.2 Остальные проверки

| Элемент плана | Факт в коде | Верность |
|---------------|-------------|----------|
| `get_active_target_channels(pool)` возвращает list[dict] с `channel_identifier` | [admin_repository.py](editor_bot/src/database/admin_repository.py) 224–234: да, поля id, channel_identifier, display_name | Верно |
| В review.py channel_ids берутся как `[ch["channel_identifier"] for ch in channels_list]` | [review.py](editor_bot/src/bot/handlers/review.py) 109–110: да | Верно |
| Fallback: `get_config_value(pool, "target_channel")` и `data.get("target_channel_id")` | review.py 112–114: да | Верно |
| `claim_pending_for_publish` не менять | repository.py: обновляет status на 'publishing' при 'pending_review'; план предписывает менять только способ выбора channel_ids | Верно |
| `publish_to_all_channels(bot, channel_ids, text, ...)` | publisher.py: принимает список channel_ids, цикл по каналам | Верно |
| Scheduler: для каждого поста из get_scheduled_posts_due вызывается publish_to_all_channels с channel_ids | scheduler.py 46–70: да, сейчас один общий channel_ids для всех постов; план предписывает для каждого поста свой список по тексту | Верно |
| Таблица keywords: id, word, added_by, created_at; UNIQUE по word | migrate_003_keywords.sql: да | Верно |
| target_channels: id, channel_identifier, display_name, is_active | migrate_004_target_channels.sql: да | Верно |
| Post: original_text, summary, edited_summary, display_summary() | models.py, repository.py: да | Верно |
| AdminStates: adding_keyword | admin_states.py: да | Верно |
| Userbot: get_keywords(pool) — все слова без группы | source_channels.py: SELECT word FROM keywords; после добавления group_id запрос остаётся валидным | Верно |

### 2.3 Уточнения, не меняющие логику

- **added_by в keyword_groups:** В плане не указано поле `added_by` для таблицы `keyword_groups`. В `target_channels` и `keywords` оно есть. Для консистентности и аудита можно добавить в миграцию 008: `added_by BIGINT`, по желанию.
- **ON DELETE для group_id:** В плане указаны два варианта (SET NULL или CASCADE). Нужно в реализации зафиксировать один: SET NULL — маркеры остаются без группы при удалении группы; CASCADE — маркеры удаляются. Рекомендация: SET NULL, чтобы не терять данные.

---

## 3. Риски и узкие места (дополнение)

| Риск | Учтён в плане? | Комментарий |
|------|----------------|-------------|
| После внедрения все старые маркеры без группы → «ни в один канал» | Да | Явный fallback: при пустом списке каналов по группам — все активные каналы / config |
| Номер миграции 006 уже занят | Нет (до аудита) | Исправлено: использовать 008 |
| Нет ни одного целевого канала | Да | Текущая логика сохраняется: fallback из config; при отсутствии — сообщение «Не задан целевой канал» |
| Пост совпал с маркерами двух групп | Да | Уникальный список channel_identifier — пост уходит в оба канала |
| Редактор не выбирает канал вручную | По дизайну | Канал определяется автоматически по маркерам; это соответствует формулировке заказчика «группы маркеров для своего канала» |

---

## 4. Выводы

1. **Вопросы заказчика:** Закрыты. Оба пункта (группы маркеров по каналам + загрузка списком) и явный отказ от стоп-слов учтены.
2. **Точность плана:** На 100% точным план был бы после единственной правки: **везде заменить миграцию 006 на 008** для групп маркеров и добавить в DEPLOY пункт про 008.
3. **Рекомендация:** Внести в план и в ТЗ исправление номера миграции (008) и при реализации добавить в DEPLOY.md команду применения `migrate_008_keyword_groups.sql` после 007.

После этой правки план можно считать полным и точным для передачи в разработку.
