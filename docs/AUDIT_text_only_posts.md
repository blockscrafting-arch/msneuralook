# Аудит: поддержка постов без PDF (только текст)

Проверка реализации с позиций: руководитель проекта, SMM, CEO, собственник, дизайнер, качество кода, безопасность, соответствие плану.

---

## 1. Соответствие плану и целям

| Пункт плана | Статус | Комментарий |
|-------------|--------|-------------|
| Userbot: убрать жёсткий PDF-фильтр, логика «есть PDF / текст / пусто» | Выполнено | Ранний return только при «нет PDF и нет текста»; при только тексте отправляется webhook с `pdf_path=""`. |
| БД: `pdf_path` не NOT NULL, миграция | Выполнено | `init.sql`: `DEFAULT ''`; `migrate_002_pdf_path_nullable.sql` для существующей БД. |
| n8n: IF по наличию PDF, две ветки, разный вход OpenAI | Выполнено | Нода «Has PDF», ветка PDF (Read → Extract → OpenAI), ветка текст (OpenAI по `post_text`). |
| Editor bot: pdf_path опционально | Выполнено | `repository`: `row["pdf_path"] or ""`; publisher/receiver уже обрабатывали отсутствие файла. |
| Тесты: только текст, PDF+текст, пустой пост | Выполнено | userbot: 4 новых теста; editor_bot: пустой pdf_path в publisher и review. |

Цель «обрабатывать только PDF, только текст, PDF+текст» достигнута. Пустые посты не уходят в воронку.

---

## 2. Качество кода (elite senior)

**Плюсы**

- Чёткое разделение: userbot → n8n → editor_bot; ветвление в n8n по одному условию (`pdf_path` не пуст).
- Типы и контракты: `pdf_path: str` везде, пустая строка как «нет файла»; в БД и репозитории учтён `NULL`/пусто.
- Логирование: в userbot есть `has_pdf=bool(pdf_path)`; ошибки webhook/скачивания логируются.
- Тесты покрывают три сценария (пустой, только текст, PDF+текст) и граничные случаи (пустой `pdf_path` в publisher/review).

**Замечания**

- В `new_post.py` при только тексте нет явного лога «text_only_post» — можно добавить для аналитики.
- В n8n дублирование полей в двух Set-нодах (source_channel, source_message_id, original_text, pdf_path) — приемлемо для наглядности веток; при росте можно вынести в общую под-воронку/шаблон.

---

## 3. Безопасность

**Реализовано**

- **Path traversal:** в editor_bot `_is_pdf_path_safe` и в publisher `_is_path_safe`: проверка `..`, `resolved.startswith(base)`. Пустой `pdf_path` не проходит в safe-check и не используется как путь — ок.
- **Webhook editor-bot:** проверка `Authorization: Bearer <token>`; при пустом токене проверка отключена (документировать для prod).
- **Ввод от n8n:** `post_id` проверяется (int, >= 1); `pdf_path` от n8n используется только после проверки безопасности и `os.path.isfile`.

**SQL (n8n)**

- INSERT в n8n собирается через подстановку: `'{{ $json.source_channel.replace(/'/g, "''") }}'` — экранирование одинарной кавычки для PostgreSQL есть.
- Параметризованных запросов в n8n для этого узла нет — риск ограничен контролируемым входом (данные из нашего же пайплайна). Для максимальной жёсткости можно перенести INSERT в отдельный сервис с параметризованным запросом.

**Рекомендации**

- В production обязательно задать `EDITOR_BOT_WEBHOOK_TOKEN` и не оставлять пустым.
- Ограничить длину полей (например, `summary`, `original_text`) на уровне приложения или БД, чтобы избежать злоупотреблений и переполнения.

---

## 4. Удобство и UX (редактор / SMM)

**Текущее поведение**

- Пост с PDF: редактор получает документ + подпись (саммари + источник).
- Пост только текст: то же сообщение с саммари и источником, но без вложения — кнопки Опубликовать / Редактировать / Отклонить те же.

**Плюсы**

- Один и тот же flow для всех типов постов; редактору не нужно переключать сценарий.
- Источник (канал + message_id) всегда виден — удобно для SMM и разбора.

**Улучшения (по желанию)**

- В тексте редактору можно явно помечать тип: например, «Тип: только текст» или «Без вложения», чтобы с первого взгляда отличать от постов с PDF.
- При публикации текстового поста в канал сейчас уходит только текст (без документа) — поведение корректное и ожидаемое.

---

## 5. Бизнес и операционная устойчивость (CEO / собственник)

**Плюсы**

- Расширение воронки: посты без PDF больше не теряются, контент-поток увеличивается.
- Аудит сохранён: `audit_log` при отправке редактору, approve, reject, edit; при публикации — «approved»/«published».
- Один и тот же процесс модерации и публикации для всех типов постов — меньше исключений и ручных сценариев.

**Риски и рекомендации**

- **Повторная доставка одного и того же поста:** при повторном вызове webhook (повтор события, retry userbot) INSERT в `posts` упрётся в `UNIQUE (source_channel, source_message_id)` и выполнение n8n упадёт с ошибкой. Редактор не получит дубликат, но в логах n8n будет ошибка. Рекомендация: в n8n обработать ошибку уникальности (например, не считать за критичную) или использовать `ON CONFLICT (source_channel, source_message_id) DO NOTHING` / `DO UPDATE` по политике (например, только обновлять `updated_at`), чтобы идемпотентно обрабатывать повторы.
- **Миграция БД:** на существующей БД нужно выполнить `migrate_002_pdf_path_nullable.sql` до деплоя новой версии n8n/userbot, иначе INSERT с пустым `pdf_path` может упасть, если в схеме ещё стоит NOT NULL.

---

## 6. Дизайн системы и именование

- **Userbot:** «новый пост» (PDF, текст или оба) — формулировка в коде и логах согласована.
- **n8n:** имена нод понятные: «Has PDF», «OpenAI PDF», «OpenAI Text Only», «Set row for Postgres», «Set row Text Only». По названиям видно, какая ветка для чего.
- **Editor bot:** без изменений в UX-словаре; «Пост #N», «Саммари», «Источник» остаются едиными для всех типов.

Схема потока (Webhook → IF → две ветки → сведение к одному Postgres → Notify) читается легко и соответствует задуманной архитектуре.

---

## 7. Дотошность руководителя проекта

**Чек-лист**

- [x] Пустой пост не уходит в webhook.
- [x] Только текст: webhook с `pdf_path=""`, в n8n идёт ветка «OpenAI Text Only», в БД `pdf_path` пустой.
- [x] PDF + текст: как раньше; `original_text` и `pdf_path` заполняются.
- [x] Только PDF: `post_text` может быть пустым; в БД и у редактора это допустимо.
- [x] Editor bot при пустом/несуществующем `pdf_path` шлёт только текст (n8n_receiver, publisher, review).
- [x] Миграция и init.sql согласованы; репозиторий не падает на `NULL` в `pdf_path`.
- [ ] Обработка дубликата (один и тот же source_message_id дважды): не реализована, рекомендуется добавить (ON CONFLICT или обработка ошибки в n8n).
- [ ] README n8n в `docs/` или `n8n/workflows/README.md` не обновлён под новую схему (IF, две ветки, текст без PDF). Имеет смысл обновить описание и диаграмму.

---

## 8. Итоговая оценка

| Критерий | Оценка | Комментарий |
|----------|--------|-------------|
| Соответствие плану | Выполнено | Все пункты плана закрыты. |
| Качество кода | Высокое | Структура, типы, тесты на уровне. |
| Безопасность | Хорошо | Path safety, auth webhook, экранирование SQL. Есть точечные улучшения (токен в prod, лимиты длины). |
| UX редактора | Хорошо | Единый сценарий; при желании — явная метка «только текст». |
| Устойчивость/бизнес | Хорошо | Аудит, расширение воронки. Рекомендуется идемпотентность при дубликатах и обновление README. |
| Дизайн/архитектура | Высокое | Понятные имена, чёткое ветвление, без лишней сложности. |

Реализация готова к продакшену при условии применения миграции БД и (рекомендуется) доработки обработки дубликатов и обновления документации workflow.
