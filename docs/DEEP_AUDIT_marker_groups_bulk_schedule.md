# Deep Code Review & Business Audit: Группы маркеров, bulk, отложка

**Режим:** безжалостная проверка. Уязвимости, говнокод, логические дыры.

---

## Исправлено (по плану)

- **1.1** В `cb_admin_kg_open` перед ранним `return` добавлен `await callback.answer()` — устранён «вечный загрузчик».
- **1.2** В `add_keyword` добавлена обработка `ForeignKeyViolationError` (return None); в `process_bulk_choose_group` — валидация выбранной группы через `get_all_keyword_groups` (ответ «Группа не найдена» при несуществующем id).
- **1.3** В `process_add_keyword_to_group` при `added is None` выводится сообщение: «Маркер не добавлен. Возможно, группа была удалена или такой маркер уже есть.»
- **Задача 5** В `process_bulk_keywords` при выбранной группе и «Добавлено: 0» добавлена подсказка: «Возможно, группа была удалена.»
- **Задача 6** Убран лишний `try/except Exception: raise` в `add_keywords_bulk`; импорт `datetime` перенесён в начало `admin.py`; форматирование списка групп вынесено в `_format_keyword_groups_text(groups)` (используется в `process_kg_choose_channel` и `cb_admin_kg_del`).
- **Тесты** В `editor_bot/tests/test_admin_repository.py`: добавлены тесты на `add_keyword` при FK, UniqueViolation и успешной вставке с `group_id`.

---

## 1. Критичные баги

### 1.1 callback.answer() не вызывается — «вечный загрузчик» ✅ ИСПРАВЛЕНО

**Файл:** [editor_bot/src/bot/handlers/admin.py](editor_bot/src/bot/handlers/admin.py), обработчик `cb_admin_kg_open`.

При `if not callback.data.startswith(prefix): return` выполняется **return без вызова `callback.answer()`**. Клиент Telegram показывает индикатор загрузки до таймаута.

**Исправление:** перед `return` вызвать `await callback.answer()` (хотя бы пустой). — **Сделано:** перед `return` добавлен `await callback.answer()`.

---

### 1.2 Некорректный group_id в bulk — необработанное исключение ✅ ИСПРАВЛЕНО

**Цепочка:** Пользователь в «Добавить списком» выбирает группу. Callback для выбора группы — `admin_gr_<id>`. **Валидации id группы нет:** можно подставить `admin_gr_99999` (несуществующая группа). В state попадает `bulk_group_id=99999`. При отправке списка слов вызывается `add_keywords_bulk(pool, words, group_id=99999)`, внутри в цикле — `add_keyword(..., group_id=99999)`. В БД срабатывает FK на `keyword_groups(id)`. **asyncpg выбрасывает `ForeignKeyViolationError`.** В `add_keyword` обрабатываются только `UniqueViolationError` и `UndefinedColumnError`; `ForeignKeyViolationError` не ловится. Исключение всплывает в `add_keywords_bulk` (там `except Exception: raise`), далее в `process_bulk_keywords` — пользователь получает падение обработчика, в логах — traceback.

**Итог:** выбор несуществующей группы в bulk приводит к необработанному исключению и плохому UX (нет сообщения об ошибке).

**Исправление:** сделаны оба варианта: в `add_keyword` добавлена обработка `ForeignKeyViolationError` (return None); в `process_bulk_choose_group` добавлена валидация — загрузка групп через `get_all_keyword_groups(pool)` и проверка, что выбранный `gid` есть в списке (или gid=0), иначе ответ «Группа не найдена».

---

### 1.3 Добавление маркера в удалённую группу ✅ ИСПРАВЛЕНО

**Сценарий:** Пользователь нажал «Добавить маркер в группу» (вход в FSM `adding_keyword_to_group` с `adding_keyword_group_id=N`). Пока он печатает слово, другой админ удаляет группу N. Пользователь отправляет сообщение. Вызывается `add_keyword(pool, word, ..., group_id=N)`. Группы N уже нет → **ForeignKeyViolationError** снова не обработан → падение.

**Исправление:** в `add_keyword` при `group_id is not None` ловить `ForeignKeyViolationError` и возвращать `None`; в `process_add_keyword_to_group` при `added is None` выдавать сообщение вроде «Маркер не добавлен. Возможно, группа была удалена или такой маркер уже есть.» — **Сделано:** добавлен `except asyncpg.ForeignKeyViolationError: return None` в `add_keyword` и обновлён текст в `process_add_keyword_to_group`.

---

## 2. Безопасность и валидация

### 2.1 Админка защищена

Роутер админки вешается с `admin_only` middleware на `message` и `callback_query`. До новых обработчиков (группы, bulk, отложка) доходят только пользователи из таблицы `admins`. Прямой обход админки без прав не виден.

### 2.2 SQL-инъекции

Параметры в БД идут через плейсхолдеры ($1, $2, …). Конкатенации SQL из пользовательского ввода нет. По текущему коду риска инъекций нет.

### 2.3 Вывод в Telegram (HTML)

В админке для пользовательского текста используется `_esc()` (html.escape). Имена групп, маркеры, названия каналов при выводе экранируются. Риск XSS в боте минимален.

### 2.4 Валидация target_channel_id при создании группы

В `process_kg_choose_channel` берётся `tc_id` из `callback.data` (admin_tc_&lt;id&gt;). **Проверки, что этот id есть в `target_channels`, нет.** Если подставить id несуществующего канала, `add_keyword_group` упрётся в FK и вернёт `None` — пользователь видит «Ошибка при создании группы». То есть падения нет, но валидация по белому списку id каналов улучшила бы понятность ошибок.

---

## 3. Логика и бизнес-правила

### 3.1 Маршрутизация: подстрока, не слово

`get_target_channel_ids_by_text` проверяет вхождение маркера в текст как **подстроку** (`word in text_lower`). Слово «бот» даст срабатывание в «робот», «боты» и т.д. Для «тематических» маркеров это может быть нежелательно (ложные срабатывания). В ТЗ явно не задано «только целое слово» — но продукт может ожидать именно слова. Стоит уточнить и при необходимости перейти на границы слов (regex или нормализация с пробелами).

### 3.2 Пустое имя группы

В `update_keyword_group` при передаче `name` вызывается `name.strip()`. Пустая строка после strip не запрещена — в БД можно записать группу с пустым именем. В интерфейсе создания группы пустое имя отсекается (`if not name`). Редактирование группы в коде не добавлено, но при возможном добавлении нужно запрещать пустое имя на уровне репозитория или хендлера.

### 3.3 Отложенные посты: только будущие?

`get_scheduled_posts_upcoming` забирает все посты со статусом `scheduled` и `scheduled_at IS NOT NULL`, без фильтра `scheduled_at > NOW()`. В списке «Отложенные посты» могут попасть посты с прошедшей датой (если планировщик их ещё не обработал). Для «плана публикаций» это может быть ок (видно и просроченные). Если продукт хочет только будущие — нужен фильтр по `scheduled_at > NOW()`.

### 3.4 Часовой пояс в отложке

Форматирование даты в МСК через `astimezone(MSK)` предполагает, что `scheduled_at` в БД — timezone-aware (UTC). Если по какой-то причине придёт naive datetime, `astimezone` вызовет ошибку. Стоит проверять `sat.tzinfo` и при необходимости локализовать (например, считать UTC).

---

## 4. Производительность и масштаб

### 4.1 Bulk: N запросов вместо одного

`add_keywords_bulk` делает в цикле до 300 вызовов `add_keyword` — до 300 round-trip к БД. В плане изначально было «один INSERT с unnest + ON CONFLICT DO NOTHING». Текущая реализация простая, но при частой загрузке больших списков станет узким местом. Рекомендация: переписать на один батч (например, unnest + ON CONFLICT) с подсчётом вставленных строк.

### 4.2 get_target_channel_ids_by_text: всё в память

Все группы и все маркеры по группам тянутся одним запросом, затем сопоставление идёт в Python. При очень большом числе групп и маркеров (тысячи) возможны рост памяти и задержки. Для типичных объёмов допустимо; при росте нагрузки можно ограничить выборку или перенести сопоставление в SQL (например, через подзапрос/функцию).

### 4.3 Нет лимита на длину имени группы

В БД `name TEXT NOT NULL`, ограничения по длине нет. Очень длинное имя может ухудшить отображение в клавиатуре (и обрезание уже есть в коде), но в БД и в callback_data лимитов нет. При желании — ограничить длину в хендлере (например, 100 символов).

---

## 5. Качество кода и согласованность

### 5.1 Дублирование текста после операций

После создания группы и после удаления группы формируется один и тот же текст списка групп вручную (цикл по `groups` и конкатенация). Логику можно вынести в одну функцию (например, `_format_keyword_groups_text(groups)`) и вызывать из обоих мест.

### 5.2 FSM: отмена при выборе канала

При выборе «Отмена» в выборе канала для новой группы callback_data = ADMIN_KG. Срабатывает `cb_admin_keyword_groups`, в котором делается `state.clear()`. Состояние сбрасывается, пользователь возвращается к списку групп. Замечаний нет.

### 5.3 Импорт внутри функции

В `_format_scheduled_list` делается `from datetime import datetime` внутри функции. В файле уже есть `from datetime import timezone` вверху. Лучше импорт datetime вынести в начало файла и не импортировать внутри функции.

### 5.4 except Exception: raise

В `add_keywords_bulk` блок `try: ... except Exception: raise` не добавляет смысла — можно убрать try/except и оставить только цикл.

---

## 6. Резюме по приоритетам

| Приоритет | Проблема | Действие |
|-----------|----------|----------|
| Критично | Нет `callback.answer()` при несовпадении prefix в `cb_admin_kg_open` | ✅ Вызвать `callback.answer()` перед return |
| Критично | `ForeignKeyViolationError` при неверном/удалённом group_id не обработан в `add_keyword` / bulk и при добавлении маркера в группу | ✅ Ловить FK в `add_keyword` (return None); валидировать group_id в `process_bulk_choose_group`; сообщение в `process_add_keyword_to_group` |
| Средне | Bulk: 300 одиночных INSERT | При необходимости перейти на один батч (unnest + ON CONFLICT) |
| Средне | Маркер = подстрока, не слово | Уточнить продукт; при необходимости ввести поиск по границам слов |
| Низко | Пустое имя группы в update | Запретить пустое имя при обновлении |
| Низко | Дублирование форматирования списка групп, импорт datetime внутри функции, лишний try/except в bulk | Рефакторинг по желанию |

---

Аудит выполнен в режиме жёсткой проверки. Критичные пункты (1.1, 1.2, 1.3) закрыты: callback.answer(), обработка ForeignKeyViolationError в add_keyword, валидация группы в process_bulk_choose_group, сообщение в process_add_keyword_to_group. Тесты: `editor_bot/tests/test_admin_repository.py` (add_keyword при FK и UniqueViolation).
