---
description: Правила для Docker, docker-compose, nginx и деплоя
globs: ["**/Dockerfile", "**/docker-compose*.yml", "**/nginx/**", "**/*.sh"]
alwaysApply: false
---

# Docker и инфраструктура

## Docker

- **Базовый образ**: `python:3.11-slim` для Python-сервисов. Минимальный набор пакетов.
- **Пользователь**: не root. Создать непривилегированного пользователя в Dockerfile (USER).
- **Слои**: кэшировать установку зависимостей отдельно от копирования кода (сначала COPY requirements.txt, pip install, потом COPY .).
- **Здоровье**: при необходимости использовать HEALTHCHECK.
- **Секреты**: не передавать через ARG в образ. Только env при запуске (docker-compose env_file / environment).

## Docker Compose

- Сервисы: postgres, n8n, userbot, editor-bot, nginx. Имена как в плане.
- Сети: одна внутренняя сеть для общения сервисов. nginx — единственный с портами 80/443 наружу (кроме отладки).
- Volumes: данные postgres, n8n, shared pdf_storage — именованные volumes. Не хранить секреты в volume.
- Зависимости: userbot зависит от n8n (или просто от сети), editor-bot — от postgres. Порядок запуска через depends_on.
- Переменные: чувствительные данные через env_file: .env (в .gitignore). В репозитории только .env.example.

## Nginx

- Конфиг в `nginx/conf.d/`: проксирование на n8n (n8n.neurascope.pro -> n8n:5678).
- Security headers: X-Frame-Options, X-Content-Type-Options, Strict-Transport-Security (при SSL).
- SSL: сертификаты через certbot (volume). HTTP -> HTTPS редирект.

## Деплой

- На VPS: установка Docker и Docker Compose при необходимости. Копирование проекта (git clone или scp).
- Файл .env создаётся вручную на сервере, не коммитится.
- Перед production: проверить, что порт PostgreSQL не открыт наружу, только внутри Docker-сети.
- Скрипты в `scripts/`: имена осмысленные (generate_session.py, backup_db.sh). В README описать, когда и как запускать.
