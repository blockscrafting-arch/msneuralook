---
description: Правила для Python-кода (userbot, editor_bot)
globs: ["**/*.py"]
alwaysApply: false
---

# Python Backend — стиль и требования

## Стиль кода

- **Python 3.11+**: типизация (type hints) для всех аргументов и возвращаемых значений публичных функций.
- **Async**: все I/O (сеть, БД, файлы) — через async/await. Использовать asyncio-совместимые библиотеки (aiohttp, asyncpg).
- **Конфигурация**: pydantic Settings с загрузкой из env. Валидация при старте приложения.
- **Именование**: snake_case для функций и переменных, PascalCase для классов. Константы — UPPER_SNAKE.

## Документация

- Каждый модуль: краткий docstring в начале (что делает модуль).
- Каждая публичная функция/класс: docstring в формате Google:
  - Краткое описание
  - Args (если есть)
  - Returns (если не None)
  - Raises (если бросает исключения)
- Сложная логика — комментарии в коде.

## Обработка ошибок

- Не глотать исключения без логирования. Логировать с уровнем error и контекстом (structlog).
- Использовать конкретные исключения; при необходимости — кастомные (наследники Exception).
- При сетевым вызовах: таймауты, retry с экспоненциальной задержкой где уместно.
- В критичных местах: try/except с логированием и повторным raise или корректным ответом (например 500 + лог).

## Логирование

- **structlog**: единый формат для всех сервисов. Конфигурация в `utils/logging.py`.
- При старте: лог уровня info с версией/компонентом.
- Ошибки: `log.error("message", exc_info=True, key=value)`.
- Не логировать секреты (токены, пароли). Маскировать при необходимости.

## Безопасность

- Не хардкодить секреты. Только переменные окружения / pydantic Settings.
- Валидировать входящие данные (webhook payload, callback_data). Проверять типы и допустимые значения.
- В боте: проверять `user.id == EDITOR_CHAT_ID` для действий редактора.
- SQL: только параметризованные запросы (asyncpg), никакой конкатенации.

## Структура модулей

- `config.py` — загрузка и валидация настроек.
- `main.py` — точка входа: инициализация логов, конфига, запуск клиента/бота.
- Обработчики в `handlers/`, бизнес-логика в `services/`, работа с БД в `database/`.
