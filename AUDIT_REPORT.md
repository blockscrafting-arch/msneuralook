# Аудит проекта: Telegram Parser & Publisher

**Дата:** 06.02.2025  
**Роли:** Руководитель проекта, SMM, CEO/собственник, дизайнер, senior-разработчик  
**Цель:** Проверка качества кода, безопасности, удобства и соответствия плану после внесённых исправлений.

---

## 1. Руководитель проекта (план и цели)

### Соответствие плану исправлений

| Блок | Статус | Комментарий |
|------|--------|-------------|
| 1A – n8n workflow | ✅ | Set-нода, INSERT RETURNING id, актуальные типы нод |
| 1B – защита webhook | ✅ | Authorization: Bearer, проверка в n8n_receiver |
| 1C – SSL / acme-challenge | ✅ | location в nginx, volumes в certbot |
| 1D – reject по статусу | ✅ | Только pending_review |
| 1E – n8n порт | ✅ | Только expose, без ports |
| 2A–2G, 3A–3E | ✅ | opentele, EDITOR_CHAT_ID int, логи, роутеры, backup, JSONB, шаблоны, /status, тесты, README |

### Цели проекта по правилам

- **Модульность:** handlers / services / database / utils выдержаны.
- **Документация:** docstrings у модулей и ключевых функций.
- **Версии и откат:** изменения можно коммитить по этапам.
- **Критичные действия в audit_log:** approve, reject, edited, sent_to_editor пишутся.

**Итог:** План и заявленные цели выполнены. Дополнительно внесены точечные улучшения по валидации и безопасности (см. ниже).

---

## 2. SMM (удобство для редактора)

### Тексты и сценарии

- **Пост на утверждение:** «Пост #id», саммари, источник (канал / msg #) — понятно, откуда пост и что править.
- **После редактирования:** «Пост #id», обновлённый текст, источник — можно повторно нажать Опубликовать/Отклонить.
- **Кнопки:** Опубликовать / Редактировать / Отклонить — однозначные действия.
- **Ответы:** «Опубликовано.» / «Отклонено.» / «Пост уже обработан или не найден.» — короткие и ясные.
- **Команды:** /start, /help объясняют назначение бота; /status показывает счётчики по статусам из БД.

### Ограничения Telegram

- Подпись к документу и текст сообщения обрезаются до 1024 символов — учтено в коде (`caption[:1024]`).

**Итог:** Интерфейс для редактора логичный, без лишних шагов, сообщения информативные.

---

## 3. CEO / собственник (риски и безопасность)

### Что закрыто

- **Секреты:** только в `.env`, не коммитятся; в коде нет хардкода паролей/токенов.
- **Webhook editor-bot:** при заданном `EDITOR_BOT_WEBHOOK_TOKEN` запросы без Bearer отклоняются (403).
- **Доступ к боту:** только `EDITOR_CHAT_ID` может нажимать кнопки и использовать команды; остальным — ответ «Доступ только у редактора.» (и для Message, и для CallbackQuery).
- **БД:** параметризованные запросы (asyncpg $1, $2…) — нет SQL-инъекций; JSONB через `json.dumps`.
- **n8n → Postgres:** в workflow экранирование кавычек для строк (`.replace(/'/g, "''")`); id и числа подставляются как числа.
- **Path traversal:** при публикации и при приёме webhook (отправка PDF редактору) проверяется, что `pdf_path` под `PDF_STORAGE_PATH`; `..` не допускается.
- **Валидация входов:**  
  - Webhook: `post_id` приводится к int, проверяется на положительность; неверный формат → 400.  
  - Callback-кнопки: из `callback.data` извлекается только валидный числовой `post_id`, иначе «Неверные данные кнопки».

### Рекомендации (не блокеры)

- Регулярные бэкапы БД (скрипт `scripts/backup_db.sh` и пример в README).
- В проде обязательно задать `EDITOR_BOT_WEBHOOK_TOKEN`.
- При переходе на HTTPS — использовать готовый пример `n8n.ssl.conf.example`.

**Итог:** Критичные риски учтены; добавлены валидация `post_id` и защита от path traversal.

---

## 4. Дизайнер (удобство и понятность интерфейса)

- **Один сценарий на пост:** пришло сообщение с кнопками → одно из трёх действий; при «Редактировать» — один запрос текста, затем снова кнопки.
- **Обратная связь:** на каждое нажатие кнопки — ответ (alert или всплывающее), кнопки после публикации/отклонения убираются.
- **Консистентность:** везде «Пост #id», потом контент, потом источник; одинаковый стиль сообщений.
- **/status:** компактный вывод по статусам («По статусам:», список) — удобно для контроля очереди.

**Итог:** Интерфейс предсказуемый, без лишних элементов, подходит для ежедневной работы редактора.

---

## 5. Senior-разработчик (качество кода)

### Архитектура и стиль

- Разделение: config, handlers, middlewares, services, database, webhook — понятные границы.
- Типизация: Post, Settings, сигнатуры с типами; `EDITOR_CHAT_ID: int` в pydantic.
- Логирование: structlog, TimeStamper в обоих сервисах; ошибки с `exc_info=True`.
- Ошибки: исключения в handlers логируются, пользователю показываются короткие сообщения.

### Внесённые в аудите правки

1. **config.py:**  
   - Валидаторы pydantic: `EDITOR_CHAT_ID` — только ненулевой ID; `TARGET_CHANNEL_ID` — не пустой после strip. Ошибка при старте с понятным сообщением.

2. **n8n_receiver:**  
   - `post_id` из JSON приводится к `int`, проверка на положительность; неверный формат → 400.  
   - Проверка `pdf_path` при отправке редактору: `_is_pdf_path_safe()` — путь только под `pdf_storage_path`, без `..`; иначе отправляется только текст без файла.  
   - Ответ 500: фиксированное сообщение «Internal server error», без утечки деталей в теле ответа.  
   - `create_app` принимает `pdf_storage_path`, сохраняет в app; типы: `pool: asyncpg.Pool`, `bot: Bot`.

3. **review.py:**  
   - Функция `_parse_post_id_from_callback(data, prefix)` — безопасное извлечение `post_id` из callback; некорректные данные → «Неверные данные кнопки».

4. **publisher.py:**  
   - `_is_path_safe(pdf_path, allowed_base)` и аргумент `pdf_storage_path` в `publish_to_channel` — защита от path traversal при публикации.

5. **middlewares:**  
   - Инжекция `pdf_storage_path` в data.  
   - Для не-редактора при `Message` (например /start) отправляется ответ «Доступ только у редактора.» для единообразного UX.

**Итог:** Код соответствует заявленному уровню; добавлены защита от некорректного `post_id` и от path traversal при публикации.

---

## 6. Сводка

| Критично | Важно | Рекомендации |
|----------|--------|---------------|
| Нет открытых критичных рисков | Все пункты плана 1A–3E выполнены | Задать WEBHOOK_TOKEN в проде, настроить бэкапы |
| Внесены: валидация post_id (webhook + callback), path traversal при публикации | UX для редактора и /status соответствуют целям | Документация (README, n8n/workflows/README.md) актуальна |

**Общий вывод:** Проект соответствует плану и намеченным целям. Качество кода, безопасность и удобство для редактора приведены к уровню, подходящему для продакшена; внесённые при аудите правки усиливают устойчивость к некорректным данным и path traversal.
