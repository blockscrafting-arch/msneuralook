# Аудит: Очередь, дедупликация, промпт

**Дата:** 06.02.2025  
**Объём:** план «Очередь, дедупликация, промпт» — реализация и проверка с позиций PM, кода (senior+), безопасности, SMM/дизайна, CEO/собственника.

---

## 1. Руководитель проекта (PM)

### Соответствие плану и целям

| Задача плана | Статус | Комментарий |
|--------------|--------|-------------|
| PROMPT_PREVIEW_LEN 300→4000 | ✅ | В admin.py задано 4000, превью укладывается в лимит Telegram (4096 минус заголовок). |
| _format_prompt_full без лимита | ✅ | Возвращает только `_esc(prompt)`, обрезки нет. |
| cb_admin_prompt_show_full частями | ✅ | Используется `split_text(text)`, несколько `send_message`, последний с клавиатурой. |
| Идемпотентность webhook (status / editor_message_id) | ✅ | Проверка внутри lock, повторный `get_post_by_id`; при уже отправленном — 200 + `already_sent`, без рассылки. |
| _webhook_lock, сериализация входящих | ✅ | `_get_webhook_lock()`, весь блок рассылки в `async with`. |
| _publish_lock в publish_to_all_channels | ✅ | Цикл по каналам обёрнут в `async with _get_publish_lock()`. |
| asyncio.sleep(2.0) перед PDF в обсуждении | ✅ | В `publish_to_channel` перед отправкой PDF. |
| Тесты: промпт частями, идемпотентность, сериализация | ✅ | test_split_text_prompt_over_4096_returns_multiple_chunks, test_handle_incoming_post_already_sent_returns_200_no_resend, test_publish_to_all_channels_serialized. |

**Риски и ограничения (документированы):**

- Очереди (webhook + publish) при пачке запросов дают задержку: второй пост ждёт завершения первого. Для типичного сценария (1–2 поста в минуту) приемлемо.
- Задержка 2 с перед PDF — компромисс между стабильностью привязки в обсуждении и скоростью; при необходимости вынесена в константу.

**Документация:** docstrings в изменённых модулях на месте; план в `.cursor/plans` актуален, todos отмечены completed.

**Итог PM:** План выполнен полностью, риски осознаны и приемлемы.

---

## 2. Качество кода (Senior+)

### Сильные стороны

- **Границы ответственности:** Lock’и и идемпотентность в одном месте (n8n_receiver), публикация — в publisher, промпт — в admin; дублирования нет.
- **Ленивая инициализация Lock:** `_get_webhook_lock()` и `_get_publish_lock()` создают Lock внутри event loop — корректно для asyncio.
- **Повторное чтение под lock:** В webhook после входа в lock вызывается повторный `get_post_by_id`, что исключает гонку между двумя одновременными запросами по одному post_id.
- **Обработка ошибок:** 400/403/404/503 с понятными телами; 500 без утечки деталей (`HTTP_500_MESSAGE`); логи с структурированными полями.
- **Тесты:** Покрыты сценарии: дубль (already_sent, send_message не вызывается), сериализация публикации (порядок start/end), длинный промпт (split на несколько чанков). В тесте с PDF замокан `asyncio.sleep`, чтобы не тянуть 2 с в CI.

### Замечания и рекомендации

1. **Промпт «Показать полностью»:** После нажатия остаётся исходное сообщение с кнопкой «Показать полностью», ниже — новые сообщения с текстом. Функционально верно; при желании улучшить UX можно редактировать первое сообщение (например, «Промпт см. ниже») или удалять его, чтобы не дублировать контекст. Не обязательно для текущего плана.
2. **Константа задержки PDF:** `PUBLISH_DELAY_BEFORE_PDF = 2.0` уже вынесена в publisher — при необходимости легко менять или делать настраиваемой из конфига.
3. **Типизация:** Использование `asyncio.Lock | None` и явные типы в сигнатурах выглядят корректно; линтер ошибок не показывает.

**Итог по коду:** Уровень реализации соответствует senior: понятная структура, минимум побочных эффектов, тесты на ключевые сценарии.

---

## 3. Безопасность

- **Идемпотентность:** Повторный POST с тем же post_id не приводит к повторной рассылке редакторам; ответ 200 + `already_sent` не раскрывает лишней информации.
- **Авторизация webhook:** Проверка `Authorization: Bearer <token>` сохранена; при неверном/отсутствующем токене — 403.
- **Входные данные:** `post_id` валидируется (int, положительный); `pdf_path` проверяется через `_is_pdf_path_safe` (no path traversal, в пределах `pdf_storage_path`). Саммари и текст проходят через `strip_markdown_asterisks` (удаление ** и *) и `html.escape` (экранирование).
- **Промпт в админке:** `_format_prompt_full` использует `_esc(prompt)`; бот с `parse_mode=HTML` — инъекция HTML в промпте исключена.
- **Блокировки:** Нет deadlock: один lock на webhook, один на публикацию; вложенных захватов нет.
- **Ответы API:** В 500 не отдаются stack trace или внутренние детали — только общее сообщение.

**Итог по безопасности:** Угрозы из плана (дубли, path traversal, инъекции) учтены; утечки информации в ответах нет.

---

## 4. SMM / Дизайн / UX

- **Превью промпта:** До 4000 символов на одном экране — редактор видит почти весь промпт без лишних кликов; обрезка с «…» только при большем объёме.
- **«Показать полностью»:** Текст приходит частями, последнее сообщение — с кнопкой «Назад»; логика предсказуемая. Как отмечено выше, исходное сообщение с кнопкой остаётся — для части пользователей это может быть плюсом (контекст «что нажал»), для части — лишним; критичным не является.
- **Редакторам:** Формат поста (номер, саммари, источник) и кнопки (Опубликовать / Редактировать / Отклонить) не менялись; дедупликация убирает дубли сообщений — UX только улучшается.
- **Публикация в канал:** Задержка перед PDF и сериализация уменьшают риск «перемешанных» постов и отвязанных PDF в обсуждении — контент для подписчиков выглядит стабильнее.

**Итог SMM/UX:** Изменения улучшают читаемость и предсказуемость без ухудшения интерфейса.

---

## 5. CEO / Собственник бизнеса

- **Дубли редакторам:** Устранены; меньше путаницы и лишних уведомлений, редактор не получает один и тот же пост дважды при ретраях n8n.
- **Стабильность ленты канала:** Очередь публикаций и пауза перед PDF снижают риск перемешанных постов и «потерянных» вложений в обсуждении — имидж канала и доверие к контенту выше.
- **Нагрузка и задержки:** При пачке входящих webhook’и обрабатываются по одному; при нескольких «Опубликовать» подряд публикации идут последовательно. Задержка — несколько секунд на пост (2 с перед PDF + 1 с между каналами). Для типичной нагрузки это приемлемо; при росте можно вынести задержки в конфиг или добавить метрики.
- **Аудит и поддержка:** Логи `incoming_post_duplicate_skipped`, `published_to_channel`, ошибки публикации по каналам — достаточно для разбора инцидентов и отчётов.

**Итог для бизнеса:** Реализация закрывает заявленные проблемы (дубли, хаос с PDF, обрезка промпта), риски под контролем, поведение системы предсказуемо.

---

## 6. Чеклист (краткий)

| Критерий | Оценка |
|----------|--------|
| Все пункты плана выполнены | ✅ |
| Тесты проходят (webhook, publisher, text_utils) | ✅ |
| Линтер без ошибок | ✅ |
| Идемпотентность webhook под lock с повторным чтением | ✅ |
| Глобальная очередь публикаций | ✅ |
| Задержка перед PDF в обсуждении | ✅ |
| Промпт: превью 4000, полный без обрезки, частями | ✅ |
| Безопасность: auth, path, HTML-экранирование | ✅ |
| Нет утечки внутренней информации в ответах | ✅ |
| Документация (docstrings, план) | ✅ |

---

## 7. Рекомендации (опционально)

1. **Метрики (если понадобится масштабирование):** Счётчики `incoming_post_duplicate_skipped`, время удержания `_publish_lock` — для мониторинга очередей.
2. **UX «Показать полностью»:** По желанию — редактировать или удалять исходное сообщение после отправки частей, чтобы уменьшить визуальный шум.
3. **Конфигурируемые задержки:** При необходимости — вынести `PUBLISH_DELAY_BEFORE_PDF` и `PUBLISH_DELAY_BETWEEN_CHANNELS` в .env/конфиг.

**Общий вывод:** Реализация соответствует плану, целям и уровню качества senior+; безопасность и удобство учтены; с точки зрения PM, кода, безопасности, SMM/дизайна и бизнеса — к внедрению готова.
